const products={},basket=getBasket();async function getProducts(){if(basket.products.length>0)return await Promise.all(basket.products.map(async t=>{products[t.id]=await getProduct(t.id),insertRow(products[t.id],t.colors)})),void loadPage("panier-table__body");document.getElementById("panier-empty").classList.remove("hide"),document.getElementById("panier-table").classList.add("hide"),loadPage("panier-empty")}function insertRow(t,e){const r=document.querySelector("tbody");e.map(e=>{const o=generateRow(t,e);o.querySelectorAll("input[name=product_numb]").forEach(function(t){t.addEventListener("change",function(){updateBasket(this)}),t.addEventListener("input",()=>{t.reportValidity()||(t.value=1)})}),o.querySelectorAll("[data-product_delete]").forEach(function(t){t.addEventListener("click",function(){removeRowFromBasket(this)})}),r.appendChild(o)})}function generateRow(t,e){const r=document.createElement("tr");return r.setAttribute("data-product_id",t._id),r.classList.add("product-row"),r.innerHTML+='<td class="product-row__delete"><img src="/assets/images/trash.svg" alt="icone de poubelle" data-product_delete></td>',r.innerHTML+='<td class="product-row__name" data-label="Nom"><a href="/product.html?id='+t._id+"&color="+e.name+'">'+t.name+"</a></td>",r.innerHTML+='<td class="product-row__color" data-label="Couleur" data-product_color><a href="/product.html?id='+t._id+"&color="+e.name+'">'+e.name+"</a></td>",r.innerHTML+='<td class="product-row__number" data-label="Nombre"><input name="product_numb" type="number" pattern="\\d+" min="1" title="Nombre de produit" value="'+e.nb+'"></td>',r.innerHTML+='<td class="product-row__price" data-label="Prix Total" data-product_price>'+formatPrice(e.nb*t.price)+"</td>",r}function updateBasket(t){const e=t.closest("tr"),r=e.getAttribute("data-product_id"),o=e.querySelector("[name=product_numb]").value;if(void 0===products[r])return addErrorToast("Le produit est introuvable");const a=basketAddOrUpdateProduct(products[r],{name:e.querySelector("[data-product_color]").textContent,nb:o});e.querySelector("[data-product_price]").textContent=formatPrice(o*products[r].price),animate_logo_basket(a),calculTotalPrice()}function removeRowFromBasket(t){const e=t.closest("tr"),r=e.querySelector("[data-product_color]").textContent,o=e.getAttribute("data-product_id"),a=localBasketRemoveProduct(o,r);e.classList.add("remove-row"),setTimeout(()=>e.remove(),150),addSuccessToast('Ce nounours a bien été supprimé <img src="/assets/images/ours_head_sade.png" alt="Tête de nounours triste">'),animate_logo_basket(a),0===a?switchElementById("panier-empty","panier-table"):calculTotalPrice()}function calculTotalPrice(){const t=basket.products.reduce((t,e)=>{return e.colors.reduce((t,e)=>parseInt(e.nb)+t,0)*products[e.id].price+t},0);document.querySelector("[data-total_price]").textContent=formatPrice(t)}async function sendForm(t){t.preventDefault();const e=await fetch("http://localhost:3000/api/teddies/order",{headers:new Headers({"Content-Type":"application/json"}),method:"POST",body:JSON.stringify({contact:getFormDatas(t.target),products:basket.products.map(t=>t.id)})}),r=await e.json();localStorage.setItem("order",r.orderId),localStorage.setItem("name",r.contact.firstName),window.location.replace("/index.html")}function getFormDatas(t){const e={};return t.querySelectorAll("input").forEach(t=>{e[t.getAttribute("name")]=t.value}),e}document.addEventListener("DOMContentLoaded",()=>{getProducts().then(()=>calculTotalPrice()).catch(t=>insertDivError(t)),setPatternError("zip","Le code postale doit être composé de 5 chiffres.","input"),setPatternError("email","L'adresse mail est invalide.","focusout"),document.getElementById("formOrder").addEventListener("submit",function(t){sendForm(t)})});